<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Take a Quiz - CertiGo</title>
    <link rel="stylesheet" href="style.css">
    <script src="auth.js"></script>
</head>
<body class="certificates-page">

<!-- NAVBAR -->
<div class="navbar">
    <div class="logo">
        <img src="C:\Users\LENOVO\Desktop\logo\36986b76-9c45-4c51-8486-c25524aba893.png" alt="CertiGo Logo">
        <h2>CertiGo</h2>
    </div>
    <nav>
        <a href="admin-index.html">Admin Dashboard</a>
        <a href="get-all-certificates.html">Certificates</a>
        <a href="get-all-companies.html">Companies</a>
        <a href="get-all-courses.html">Courses</a>
        <a href="get-all-lessons.html">Lessons</a>
        <a href="get-all-quizzes.html" class="admin-only">Quizzes</a>
    </nav>
    <div class="dropdown">
        <button class="dropbtn" id="accountBtn">Account</button>
        <div class="dropdown-content" id="accountDropdown">
            <a href="#" onclick="showUserProfile(); return false;">Profile</a>
            <a href="#" onclick="logout(); return false;">Logout</a>
        </div>
    </div>
</div>

<div class="certificates-container">
    <div class="certificates-header">
        <h1>Take a Quiz</h1>
        <p>Select a quiz to test your knowledge!</p>
    </div>

    <div id="loading" class="certificates-loading">
        <div class="certificates-spinner"></div>
        <p style="color: #666; font-size: 16px;">Loading quizzes...</p>
    </div>

    <!-- Quiz Selection -->
    <div id="quizSelection" style="display: none;">
        <h3>Available Quizzes</h3>
        <div id="quizList"></div>
    </div>

    <!-- Quiz Taking -->
    <div id="quizContainer" style="display: none;">
        <div id="questionContainer">
            <h3 id="questionText"></h3>
            <div id="optionsContainer"></div>
        </div>
        <div style="margin-top: 20px;">
            <button id="prevBtn" class="cert-btn" onclick="prevQuestion()" disabled>Previous</button>
            <button id="nextBtn" class="cert-btn cert-btn-primary" onclick="nextQuestion()">Next</button>
            <button id="submitBtn" class="cert-btn cert-btn-success" onclick="submitQuiz()" style="display: none;">Submit Quiz</button>
        </div>
    </div>

    <!-- Results -->
    <div id="resultsContainer" style="display: none;">
        <h3>Your Score: <span id="score"></span></h3>
        <div id="resultsDetails"></div>
        <button class="cert-btn" onclick="retakeQuiz()">Retake Quiz</button>
        <button class="cert-btn" onclick="goBack()">Back to Lessons</button>
    </div>

    <!-- Empty State -->
    <div id="emptyState" class="certificates-empty-state" style="display: none;">
        <div class="certificates-empty-state-icon">❓</div>
        <h3>No Quizzes Available</h3>
        <p>There are no active quizzes at the moment. Check back later!</p>
        <button class="cert-btn" onclick="goBack()">Back to Lessons</button>
    </div>
</div>

<script>
    let allQuizzes = [];
    let currentQuiz = null;
    let currentQuestionIndex = 0;
    let userAnswers = [];
    let quizResults = [];

    // Check authentication on page load
    window.addEventListener('DOMContentLoaded', () => {
        if (!requireAuth()) return;
        if (!hasPermission('take_quiz')) {  // ✅ Changed to 'take_quiz' for trainee-only access
            alert('Access Denied: You do not have permission to take quizzes.');
            redirectToHomePage();
            return;
        }
        loadQuizzes();
    });

    async function loadQuizzes() {
        showLoading(true);

        try {
            const response = await fetch('http://localhost:8080/quiz/getAll', {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                }
            });

            if (response.ok) {
                allQuizzes = await response.json();
                const activeQuizzes = allQuizzes.filter(quiz => quiz.isActive);
                if (activeQuizzes.length > 0) {
                    displayQuizSelection(activeQuizzes);
                } else {
                    showEmptyState();
                }
                showLoading(false);
            } else {
                showLoading(false);
                alert('Failed to load quizzes. Please try again.');
            }
        } catch (error) {
            showLoading(false);
            console.error('Error:', error);
            alert('Network error. Please check your connection and try again.');
        }
    }

    function displayQuizSelection(quizzes) {
        const quizList = document.getElementById('quizList');
        quizList.innerHTML = '';

        quizzes.forEach(quiz => {
            const quizCard = document.createElement('div');
            quizCard.className = 'quiz-card';
            quizCard.innerHTML = `
                <h4>${escapeHtml(quiz.quizTitle)}</h4>
                <p>${escapeHtml(quiz.description || 'No description')}</p>
                <p>Duration: ${quiz.duration || 'N/A'} minutes | Passing Score: ${quiz.passingScore || 'N/A'}%</p>
                <button class="cert-btn cert-btn-primary" onclick="startQuiz(${quiz.id})">Start Quiz</button>
            `;
            quizList.appendChild(quizCard);
        });

        document.getElementById('quizSelection').style.display = 'block';
    }

    async function startQuiz(quizId) {
        currentQuiz = allQuizzes.find(q => q.id === quizId);

        // Fetch questions with options from the database
        try {
            const response = await fetch(`http://localhost:8080/question/getByQuizId?quizId=${quizId}`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                }
            });

            if (response.ok) {
                const questions = await response.json();
                if (!questions || questions.length === 0) {
                    alert('This quiz has no questions.');
                    return;
                }

                currentQuiz.questions = questions;
                userAnswers = new Array(questions.length).fill(null);
                quizResults = [];
                currentQuestionIndex = 0;

                document.getElementById('quizSelection').style.display = 'none';
                document.getElementById('quizContainer').style.display = 'block';
                displayQuestion();
            } else {
                alert('Failed to load quiz questions. Please try again.');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Network error. Please check your connection and try again.');
        }
    }

    function displayQuestion() {
        const question = currentQuiz.questions[currentQuestionIndex];
        document.getElementById('questionText').textContent = `Question ${currentQuestionIndex + 1}: ${question.questionText}`;

        const optionsContainer = document.getElementById('optionsContainer');
        optionsContainer.innerHTML = '';

        if (question.options && question.options.length > 0) {
            question.options.forEach((option, index) => {
                const optionDiv = document.createElement('div');
                optionDiv.className = 'quiz-option';
                const isChecked = userAnswers[currentQuestionIndex] && userAnswers[currentQuestionIndex].selectedOptionId === option.id;
                optionDiv.innerHTML = `
                    <input type="radio" id="option${option.id}" name="quizOption" value="${option.id}" ${isChecked ? 'checked' : ''}>
                    <label for="option${option.id}">${escapeHtml(option.optionText)}</label>
                `;
                optionsContainer.appendChild(optionDiv);
            });
        }

        // Update navigation buttons
        document.getElementById('prevBtn').disabled = currentQuestionIndex === 0;
        document.getElementById('nextBtn').style.display = currentQuestionIndex < currentQuiz.questions.length - 1 ? 'inline-block' : 'none';
        document.getElementById('submitBtn').style.display = currentQuestionIndex === currentQuiz.questions.length - 1 ? 'inline-block' : 'none';
    }

    function nextQuestion() {
        // Save current answer
        const selectedOption = document.querySelector('input[name="quizOption"]:checked');
        const question = currentQuiz.questions[currentQuestionIndex];

        if (selectedOption) {
            userAnswers[currentQuestionIndex] = {
                questionId: question.id,
                selectedOptionId: parseInt(selectedOption.value)
            };
        } else {
            userAnswers[currentQuestionIndex] = null;
        }

        if (currentQuestionIndex < currentQuiz.questions.length - 1) {
            currentQuestionIndex++;
            displayQuestion();
        }
    }

    function prevQuestion() {
        // Save current answer
        const selectedOption = document.querySelector('input[name="quizOption"]:checked');
        const question = currentQuiz.questions[currentQuestionIndex];

        if (selectedOption) {
            userAnswers[currentQuestionIndex] = {
                questionId: question.id,
                selectedOptionId: parseInt(selectedOption.value)
            };
        } else {
            userAnswers[currentQuestionIndex] = null;
        }

        if (currentQuestionIndex > 0) {
            currentQuestionIndex--;
            displayQuestion();
        }
    }

    async function submitQuiz() {
        // Save final answer
        const selectedOption = document.querySelector('input[name="quizOption"]:checked');
        const question = currentQuiz.questions[currentQuestionIndex];

        if (selectedOption) {
            userAnswers[currentQuestionIndex] = {
                questionId: question.id,
                selectedOptionId: parseInt(selectedOption.value)
            };
        } else {
            userAnswers[currentQuestionIndex] = null;
        }

        // Calculate score
        let correctAnswers = 0;
        currentQuiz.questions.forEach((question, index) => {
            const userAnswer = userAnswers[index];
            if (userAnswer) {
                const selectedOption = question.options.find(opt => opt.id === userAnswer.selectedOptionId);
                const correctOption = question.options.find(opt => opt.isCorrect);
                const isCorrect = selectedOption && selectedOption.isCorrect;
                if (isCorrect) correctAnswers++;
                quizResults.push({
                    question: question.questionText,
                    userAnswer: selectedOption ? selectedOption.optionText : 'No answer',
                    correctAnswer: correctOption ? correctOption.optionText : 'N/A',
                    isCorrect
                });
            } else {
                const correctOption = question.options.find(opt => opt.isCorrect);
                quizResults.push({
                    question: question.questionText,
                    userAnswer: 'No answer',
                    correctAnswer: correctOption ? correctOption.optionText : 'N/A',
                    isCorrect: false
                });
            }
        });

        const score = Math.round((correctAnswers / currentQuiz.questions.length) * 100);

        // Save quiz result first
        try {
            const user = JSON.parse(localStorage.getItem('user'));
            if (!user || !user.id) {
                alert('User not logged in. Please log in to save your results.');
                return;
            }

            // Create quiz result
            const quizResultResponse = await fetch('http://localhost:8080/quizResult/create', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    score: score,
                    isPassed: score >= (currentQuiz.passingScore || 70),
                    userId: user.id,
                    quizId: currentQuiz.id
                })
            });

            if (quizResultResponse.ok) {
                const quizResult = await quizResultResponse.json();

                // Prepare user answers for bulk save
                const answersToSave = userAnswers
                    .filter(answer => answer !== null)
                    .map(answer => ({
                        questionId: answer.questionId,
                        selectedOptionId: answer.selectedOptionId
                    }));

                // Save user answers in bulk
                if (answersToSave.length > 0) {
                    const userAnswersResponse = await fetch('http://localhost:8080/UserAnswer/createBulk', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            userId: user.id,
                            quizId: currentQuiz.id,
                            quizResultId: quizResult.id,
                            answers: answersToSave
                        })
                    });

                    if (!userAnswersResponse.ok) {
                        console.error('Failed to save user answers');
                    }
                }

                // Display results
                document.getElementById('score').textContent = `${score}% (${correctAnswers}/${currentQuiz.questions.length})`;

                const resultsDetails = document.getElementById('resultsDetails');
                resultsDetails.innerHTML = '';
                quizResults.forEach((result, index) => {
                    const resultDiv = document.createElement('div');
                    resultDiv.className = `quiz-result ${result.isCorrect ? 'correct' : 'incorrect'}`;
                    resultDiv.innerHTML = `
                        <h4>Question ${index + 1}: ${escapeHtml(result.question)}</h4>
                        <p>Your Answer: ${escapeHtml(result.userAnswer)}</p>
                        <p>Correct Answer: ${escapeHtml(result.correctAnswer)}</p>
                        <p>${result.isCorrect ? '✓ Correct' : '✗ Incorrect'}</p>
                    `;
                    resultsDetails.appendChild(resultDiv);
                });

                document.getElementById('quizContainer').style.display = 'none';
                document.getElementById('resultsContainer').style.display = 'block';
            } else {
                alert('Failed to save quiz result. Please try again.');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Network error. Your answers could not be saved.');
        }
    }

    function retakeQuiz() {
        document.getElementById('resultsContainer').style.display = 'none';
        startQuiz(currentQuiz.id);
    }

    function goBack() {
        window.location.href = 'get-all-lessons.html';
    }

    function showLoading(show) {
        document.getElementById('loading').style.display = show ? 'block' : 'none';
    }

    function showEmptyState() {
        document.getElementById('emptyState').style.display = 'block';
    }

    // Helper function to escape HTML
    function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
</script>
</body>
</html>