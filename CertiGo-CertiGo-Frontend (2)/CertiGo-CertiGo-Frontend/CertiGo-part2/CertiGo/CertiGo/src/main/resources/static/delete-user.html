<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Delete User - CertiGo</title>
    <link rel="stylesheet" href="style.css">
    <script src="auth.js"></script>
</head>
<body class="certificates-page">

<!-- NAVBAR -->
<div class="navbar">
    <div class="logo">
        <img src="C:\Users\LENOVO\Desktop\logo\36986b76-9c45-4c51-8486-c25524aba893.png" alt="CertiGo Logo">
        <h2>CertiGo</h2>
    </div>
    <nav>
        <a href="admin-index.html">Admin Dashboard</a>
        <a href="get-all-users.html">Users</a>
    </nav>
    <div class="dropdown">
        <button class="dropbtn" id="accountBtn">Account</button>
        <div class="dropdown-content" id="accountDropdown">
            <a href="#" onclick="showUserProfile(); return false;">Profile</a>
            <a href="#" onclick="logout(); return false;">Logout</a>
        </div>
    </div>
</div>

    <div class="certificates-container">
        <div class="certificates-header">
            <h1>Delete User</h1>
            <p>Search and delete users from the system</p>
        </div>

        <div id="successMessage" class="certificates-success-message" style="display: none;">
            User deleted successfully!
        </div>

        <div id="errorAlert" class="certificates-error-alert" style="display: none;">
            Failed to delete user. Please try again.
        </div>

        <div class="certificates-controls">
            <div class="certificates-search-box">
                <input type="number" id="userIdInput" placeholder="Enter User ID to search..." min="1">
            </div>
            <div style="display: flex; gap: 10px;">
                <button class="cert-btn cert-btn-primary" onclick="searchUser()">üîç Search User</button>
                <a href="get-all-users.html" class="cert-btn cert-btn-refresh">üë• View All Users</a>
            </div>
        </div>

        <div id="loading" class="certificates-loading" style="display: none;">
            <div class="certificates-spinner"></div>
            <p style="color: #666; font-size: 16px;">Loading user...</p>
        </div>

        <div id="userDetailsContainer" class="certificates-table-container" style="display: none; padding: 30px; background: white; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
            <h2 style="color: #333; margin-bottom: 20px;">User Details</h2>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px;">
                <div>
                    <p style="color: #666; margin-bottom: 5px;"><strong>ID:</strong></p>
                    <p id="userId" style="color: #333; font-size: 16px;">-</p>
                </div>
                <div>
                    <p style="color: #666; margin-bottom: 5px;"><strong>Full Name:</strong></p>
                    <p id="userFullName" style="color: #333; font-size: 16px;">-</p>
                </div>
                <div>
                    <p style="color: #666; margin-bottom: 5px;"><strong>Email:</strong></p>
                    <p id="userEmail" style="color: #333; font-size: 16px;">-</p>
                </div>
                <div>
                    <p style="color: #666; margin-bottom: 5px;"><strong>Phone:</strong></p>
                    <p id="userPhone" style="color: #333; font-size: 16px;">-</p>
                </div>
                <div>
                    <p style="color: #666; margin-bottom: 5px;"><strong>Role:</strong></p>
                    <p id="userRole" style="color: #333; font-size: 16px;">-</p>
                </div>
                <div>
                    <p style="color: #666; margin-bottom: 5px;"><strong>Status:</strong></p>
                    <p id="userStatus" style="color: #333; font-size: 16px;">-</p>
                </div>
                <div>
                    <p style="color: #666; margin-bottom: 5px;"><strong>Created At:</strong></p>
                    <p id="userCreatedAt" style="color: #333; font-size: 16px;">-</p>
                </div>
                <div>
                    <p style="color: #666; margin-bottom: 5px;"><strong>Updated At:</strong></p>
                    <p id="userUpdatedAt" style="color: #333; font-size: 16px;">-</p>
                </div>
            </div>

            <div style="background: #fff3cd; border: 1px solid #ffc107; border-radius: 5px; padding: 15px; margin-bottom: 20px;">
                <p style="color: #856404; margin: 0;">
                    <strong>‚ö†Ô∏è Warning:</strong> This action cannot be undone. Deleting this user will permanently remove all associated data including enrollments, quiz results, and reviews.
                </p>
            </div>

            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                <button class="cert-btn cert-btn-refresh" onclick="clearUserDetails()">Cancel</button>
                <button class="cert-btn cert-btn-delete" onclick="confirmDelete()">üóëÔ∏è Delete User</button>
            </div>
        </div>

        <div id="emptyState" class="certificates-empty-state">
            <div class="certificates-empty-state-icon">üîç</div>
            <h3>Search for a User</h3>
            <p>Enter a User ID above to search and delete a user from the system.</p>
            <a href="get-all-users.html" class="cert-btn cert-btn-primary">View All Users</a>
        </div>
    </div>

    <script>
        let currentUser = null;

        // Check authentication on page load
        window.addEventListener('DOMContentLoaded', () => {
            // Require admin access for this page
            requireAdmin();
        });

        async function searchUser() {
            const userId = document.getElementById('userIdInput').value;

            if (!userId || userId <= 0) {
                showError('Please enter a valid User ID.');
                return;
            }

            showLoading(true);
            hideError();
            hideSuccess();

            try {
                const response = await fetch(`http://localhost:8080/users/${userId}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                if (response.ok) {
                    currentUser = await response.json();
                    displayUserDetails(currentUser);
                    showLoading(false);
                } else if (response.status === 404) {
                    showLoading(false);
                    showError(`User with ID ${userId} not found.`);
                    clearUserDetails();
                } else {
                    showLoading(false);
                    showError('Failed to load user. Server returned an error.');
                    clearUserDetails();
                }
            } catch (error) {
                showLoading(false);
                console.error('Error:', error);
                showError('Network error. Please check your connection and try again.');
                clearUserDetails();
            }
        }

        function displayUserDetails(user) {
            document.getElementById('emptyState').style.display = 'none';
            document.getElementById('userDetailsContainer').style.display = 'block';

            const fullName = `${user.firstName || ''} ${user.lastName || ''}`.trim() || 'N/A';

            document.getElementById('userId').textContent = user.id || 'N/A';
            document.getElementById('userFullName').textContent = fullName;
            document.getElementById('userEmail').textContent = user.email || 'N/A';
            document.getElementById('userPhone').textContent = user.phoneNumber || 'N/A';
            document.getElementById('userRole').textContent = user.role || 'N/A';
            document.getElementById('userStatus').textContent = user.isActive ? 'Active' : 'Inactive';
            document.getElementById('userCreatedAt').textContent = user.createdAt
                ? new Date(user.createdAt).toLocaleString()
                : 'N/A';
            document.getElementById('userUpdatedAt').textContent = user.updatedAt
                ? new Date(user.updatedAt).toLocaleString()
                : 'N/A';
        }

        function clearUserDetails() {
            currentUser = null;
            document.getElementById('userIdInput').value = '';
            document.getElementById('userDetailsContainer').style.display = 'none';
            document.getElementById('emptyState').style.display = 'block';
            hideError();
            hideSuccess();
        }

        async function confirmDelete() {
            if (!currentUser) {
                showError('No user selected for deletion.');
                return;
            }

            const fullName = `${currentUser.firstName || ''} ${currentUser.lastName || ''}`.trim() || `User #${currentUser.id}`;

            const confirmation = confirm(
                `Are you absolutely sure you want to delete ${fullName}?\n\n` +
                `This will permanently delete:\n` +
                `- User account and profile\n` +
                `- All enrollments\n` +
                `- All quiz results and answers\n` +
                `- All reviews\n` +
                `- All associated data\n\n` +
                `This action CANNOT be undone!`
            );

            if (!confirmation) {
                return;
            }

            // Double confirmation for safety
            const doubleConfirm = confirm(
                `FINAL CONFIRMATION:\n\n` +
                `Type "DELETE" in the next prompt to confirm deletion of ${fullName}.`
            );

            if (!doubleConfirm) {
                return;
            }

            const confirmText = prompt('Type DELETE (in capital letters) to confirm:');

            if (confirmText !== 'DELETE') {
                showError('Deletion cancelled. Confirmation text did not match.');
                return;
            }

            await deleteUser(currentUser.id);
        }

        async function deleteUser(userId) {
            showLoading(true);
            hideError();
            hideSuccess();

            try {
                const response = await fetch(`http://localhost:8080/users/${userId}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                if (response.ok || response.status === 204) {
                    showLoading(false);
                    showSuccess(`User #${userId} has been successfully deleted!`);
                    clearUserDetails();

                    // Redirect to users list after 2 seconds
                    setTimeout(() => {
                        window.location.href = 'get-all-users.html';
                    }, 2000);
                } else {
                    showLoading(false);
                    const errorText = await response.text();
                    showError(`Failed to delete user #${userId}. ${errorText}`);
                }
            } catch (error) {
                showLoading(false);
                console.error('Error:', error);
                showError('Network error. Please check your connection and try again.');
            }
        }

        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
        }

        function showError(message) {
            const errorAlert = document.getElementById('errorAlert');
            errorAlert.textContent = message;
            errorAlert.style.display = 'block';
            setTimeout(() => {
                errorAlert.style.display = 'none';
            }, 5000);
        }

        function hideError() {
            document.getElementById('errorAlert').style.display = 'none';
        }

        function showSuccess(message) {
            const successMessage = document.getElementById('successMessage');
            successMessage.textContent = message;
            successMessage.style.display = 'block';
        }

        function hideSuccess() {
            document.getElementById('successMessage').style.display = 'none';
        }

        // Allow Enter key to trigger search
        document.getElementById('userIdInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchUser();
            }
        });
    </script>
</body>
</html>
