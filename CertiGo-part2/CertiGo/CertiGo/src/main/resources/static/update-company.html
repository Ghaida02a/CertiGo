<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Update Company - CertiGo Admin</title>
    <link rel="stylesheet" href="style.css">
    <script src="auth.js"></script>
    <script>
        // Use the auth utility to restrict access
        if (typeof requireAdmin === "function") {
            requireAdmin();
        }
    </script>
    <style>
        .form-container {
            max-width: 600px;
            margin: 30px auto;
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; color: #333; }
        .form-group input, .form-group select {
            width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;
        }
        .search-section {
            display: flex; gap: 10px; margin-bottom: 25px; padding-bottom: 20px; border-bottom: 1px solid #eee;
        }
        .update-btn { width: 100%; padding: 14px; font-size: 16px; margin-top: 10px; cursor: pointer; }
    </style>
</head>
<body class="certificates-page">

<div class="navbar">
    <div class="logo"><h2>CertiGo</h2></div>
    <nav>
        <a href="admin-index.html">Admin Dashboard</a>
        <a href="get-all-companies.html">Companies</a>
    </nav>
</div>

<div class="certificates-container">
    <div class="certificates-header" style="text-align: center; margin-top: 20px;">
        <h1>Update Company</h1>
        <p>Modify details for ID: <span id="displayIdText">None</span></p>
    </div>

    <div id="successMessage" class="certificates-success-message" style="display: none; background: #d4edda; color: #155724; padding: 10px; border-radius: 5px; margin: 10px;"></div>
    <div id="errorAlert" class="certificates-error-alert" style="display: none; background: #f8d7da; color: #721c24; padding: 10px; border-radius: 5px; margin: 10px;"></div>

    <div class="form-container">
        <div class="search-section">
            <div style="flex-grow: 1;">
                <input type="number" id="searchId" placeholder="Enter Company ID (e.g. 1)">
            </div>
            <button class="cert-btn cert-btn-primary" onclick="fetchCompany()">Fetch Details</button>
        </div>

        <form id="updateForm" style="display: none;">
            <input type="hidden" id="companyId">

            <div class="form-group">
                <label>Company Name</label>
                <input type="text" id="companyName" required>
            </div>

            <div class="form-group">
                <label>Contact Email</label>
                <input type="email" id="contactEmail" required>
            </div>

            <div class="form-group">
                <label>Location</label>
                <input type="text" id="location">
            </div>

            <div class="form-group">
                <label>Industry</label>
                <input type="text" id="industry">
            </div>

            <div class="form-group">
                <label>Status</label>
                <select id="isActive">
                    <option value="true">Active</option>
                    <option value="false">Inactive</option>
                </select>
            </div>

            <button type="submit" class="cert-btn cert-btn-primary update-btn">Update Records</button>
        </form>
    </div>
</div>

<script>
    const baseUrl = 'http://localhost:8080/company';

    // Auto-load if ID is in URL
    window.addEventListener('DOMContentLoaded', () => {
        const urlParams = new URLSearchParams(window.location.search);
        const id = urlParams.get('companyId');
        if (id && id !== "undefined") {
            document.getElementById('searchId').value = id;
            fetchCompany();
        }
    });

    async function fetchCompany() {
        const id = document.getElementById('searchId').value;
        const errorAlert = document.getElementById('errorAlert');
        errorAlert.style.display = 'none';

        if (!id) return;

        try {
            // Using /getAll to verify if the service is even sending the ID
            const response = await fetch(`${baseUrl}/getAll`);
            const allCompanies = await response.json();

            // Find ID 1 in the list returned by your API
            const company = allCompanies.find(c => c.id == id);

            if (company) {
                document.getElementById('companyId').value = company.id;
                document.getElementById('displayIdText').textContent = company.id;
                document.getElementById('companyName').value = company.companyName || '';
                document.getElementById('contactEmail').value = company.contactEmail || '';
                document.getElementById('location').value = company.location || '';
                document.getElementById('industry').value = company.industry || '';
                document.getElementById('isActive').value = company.isActive.toString();

                document.getElementById('updateForm').style.display = 'block';
            } else {
                errorAlert.textContent = `Company ID ${id} not found in the active list. Check if 'is_active' is true in DB.`;
                errorAlert.style.display = 'block';
                document.getElementById('updateForm').style.display = 'none';
            }
        } catch (e) {
            errorAlert.textContent = "Backend Connection Error.";
            errorAlert.style.display = 'block';
        }
    }

    document.getElementById('updateForm').addEventListener('submit', async (e) => {
        e.preventDefault();

        const updateData = {
            companyId: parseInt(document.getElementById('companyId').value),
            companyName: document.getElementById('companyName').value,
            contactEmail: document.getElementById('contactEmail').value,
            location: document.getElementById('location').value,
            industry: document.getElementById('industry').value,
            isActive: document.getElementById('isActive').value === "true"
        };

        try {
            const response = await fetch(`${baseUrl}/Update`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(updateData)
            });

            if (response.ok) {
                document.getElementById('successMessage').textContent = "Update Successful!";
                document.getElementById('successMessage').style.display = 'block';
                setTimeout(() => window.location.href = 'get-all-companies.html', 1500);
            } else {
                alert("Update failed. Check backend console.");
            }
        } catch (e) {
            alert("Network Error.");
        }
    });
</script>
</body>
</html>